<html>
<head>
<title>The Systo publish-subscribe (pub-sub) mechanism</title>
</head>

<body style="font-family:sans-serif; font-size:14px;">
<h1>The Systo publish-subscribe (pub-sub) mechanism for communication between widgets</h1>

<div style="width:200px; border:solid 1px #808080; padding:20px; margin:10px; float:right;">
<a href="#change_model_listener">change_model_listener</a><br/>
<a href="#diagram_listener">diagram_listener</a><br/>
</div>

<p>Systo widgets are independent units, potentially developed by people anywhere in the world with no knowledge of the widgets rsdeveloped by other people.   Any web page developer can then select any subset of the available widgets for incorporating in their web pages.  For this reason, there needs to be agreed protocols to allow wigets to communicate with each other.</p>

<p>Such communication can be take two forms: sharing of state; and responding to events.</p>

<p>Sharing of state takes place through the global SYSTO object.  This includes a complete representation of the structure of the model or models currently in play, the modelling languages used by these models, as well as more transient information such as the ID of the current model.   This requires that each widget developer knows about the data structure used by the SYSTO object.   [Eventually, there will be an API involving getters and setters for accessing this information, and this will isolate the programmer from the actual data structure, but that has not yet been developed.]/p>

<p>However, there are many situations where access to the SYSTO state is not sufficient: widgets will not know that state has changed and they need to do something.    Examples include:
<ul>
<li>The user changes the structure of the model, and all widgets which display the model should immediately reflect the change.</li>
<li>The user runs the model, and all widgets which display results should update their display.</li>
</ul></p>

<p>There is therefore a need to notify widgets that something has happened and that they need to respond.  There is a general mechanism for doing this, known as the <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">"publish-subscribe pattern"</a>.   The basic idea is that one bit of code "publishes" a certain type of message, and other bits of code are engineered so that they detect when this happens, because they are listening out for messages of that type.  This is a big topic, and there are a number of libraries for implementing it.  Some require that the publisher maintains a list of subscribers; in others, there is no need for that.</p>

<p>There are a number of JavaScript pub/sub libraries available, but Systo does not use any of these.  Instead, it uses native jQuery mechanisms for triggering custom event and for listening out for these.</p>

<h3>Publisher (triggering widget)</h3>
<p>This is the code that goes in the widget that is triggering (publishing) an event:</p>
<pre style="font-family:courier">
    $('.abc_listener').trigger('click', [a,b]);
</pre>
<p>In this case, the event type is named "abc_listener", and is sent to all elements which have this class (the full-stop is the jQuery selector for a CSS class).   Two arguments are passed to the subscribers (listeners): a and b.   These can be any Javascript structure - a string, number, array or object.</p>

<p>When you look at the code for Systo widgets,you will not see the above pattern.  Instaed, I have created a very lightweight layer on top of this, a function (SYSTO.trigger()) defined in systo.js.   This is purely to allow extra information to be passed about each event through a central pinch-point, so that a log can be kept of all events, for debuging and performance analysis.</p>

<h3>Subscriber (listening widget)</h3>
<p>This is the code that goes in the _create method for the widget;</p>
<pre font-family="courier">
        $(document).on('highlight_listener', {}, function(event, parameters) {
            ... 
        });
</pre>


<hr size="3"/>
<h2>Current pubsub events</h2>

<hr/>
<a name="change_model_listener"><h3>change_model_listener</h3></a>
<p>Signifies that one model has replaced another as the current model.   (Note: the language "change model" is potentially confusing.  Here it means changing from one model to another, <u>not</u> change to the structure of the current model.)</p>

<b>Attributes</b><br/>
<ul>
<li><b>oldModelId</b> - the ID of the old model;</li>
<li><b>newModelId</b> - the ID of the new model.</li>
</ul>

<hr/>
<a name="diagram_listener"><h3>diagram_listener</h3></>
<p>Signifies that there has been a change to the model structure (e.g. adding, moving or deleting a node), so any widget which displays the model (in diagrammatic or text form) may wish to respond to this to re-display the model.</p>

<b>Attributes</b><br>
None

<hr/>


</body>
</html>

